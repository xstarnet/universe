# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Critical Note
DO NOT run anything in the local environment. This document provides only guidance for code review and modification.

## High-Level Code Architecture and Structure

This is a Go-based backend application built with CloudWeGo Hertz framework, following a typical MVC-like architecture:

1. **Main Application (`main.go`)**:
   - Entry point that initializes external services (Aliyun, MongoDB, Redis)
   - Starts the Hertz server

2. **Business Logic Layer (`biz/`)**:
   - `handler/`: Request handlers that handle HTTP requests
   - `model/`: Data models and business objects
   - `router/`: Route definitions for the application

3. **Data Access Layer (`gdb/`)**:
   - Singleton `GDB` client that manages connections to MongoDB and Redis
   - Methods for initializing and disposing of database connections

4. **Utilities (`utils/`)**:
   - `aliyun.go`: Aliyun SMS service integration
   - `mongo.go`: MongoDB utility functions
   - `net.go`: HTTP response formatting utilities
   - `lang.go`: Common Go language utilities

5. **Command Line Interface (`cli/`)**:
   - Command line tool with deploy, log, and other utilities

6. **IDL Definitions (`idl/`)**:
   - Thrift IDL files for service definitions

## Common Development Commands

### Build the Application
```bash
./build.sh
```

### Build the CLI Tool
```bash
./build-cli.sh
```

### Run the Application
```bash
./universe
```

## Key Dependencies
- CloudWeGo Hertz: HTTP framework
- MongoDB: Database
- Redis: Cache
- Aliyun SMS: SMS service integration

## Development Notes
- The application follows a simple singleton pattern for database connections
- HTTP responses are formatted consistently using the `HttpResponse` struct in `utils/net.go`
- The CLI tool provides deploy and log management capabilities
- User authentication uses phone number + SMS verification flow
- **Important**: According to hz generating rules, all business logic should be put in the nested files generated by the framework, not in the parent directory files. For example, user service logic should be in `biz/handler/user/user/user_service.go` instead of `biz/handler/user/user_service.go`
- **Important**: When using the "hz" command to update generated code from IDL files:
  - DO NOT use "hz new" as this will regenerate main.go and build.go, which should not be rewritten after initial creation
  - Use "hz update" with the updated IDL file instead to limit modifications to only necessary files
  - Ensure IDL updates do not break existing logic unless explicitly required

## Login Module Implementation

### API Endpoints
1. **Send SMS Code**: `POST /v1/users/sms-code`
   - Sends a 6-digit verification code to the user's phone via Aliyun SMS
   - Code is stored in Redis with 5 minutes expiration

2. **Login**: `POST /v1/users/login`
   - Verifies SMS code against Redis
   - Automatically creates user if not exists in database
   - Generates:
     - JWT token (15 minutes expiration) for API authentication
     - Refresh token (7 days expiration) for token renewal
   - Stores refresh token in Redis
   - Returns both tokens in response

3. **Logout**: `POST /v1/users/logout`
   - Invalidates the refresh token by removing it from Redis

4. **Refresh Token**: `POST /v1/users/refresh-token`
   - Validates existing refresh token
   - Generates new JWT and refresh tokens
   - Stores new refresh token in Redis
   - Returns new tokens in response

### JWT Authentication
- JWT tokens are signed using HS256 algorithm with a secret key
- Secret key is defined in `biz/handler/user/user/user_service.go` as `jwtSecret`
- Token contains user ID as subject, expires in 15 minutes
- In production, secret key should be stored in an environment variable